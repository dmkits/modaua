<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/gif" href="/icons/moda32x32.ico"/>
    <![endif]-->
    <script src="/jslib/handsontable/handsontable.full.min.js"></script>
    <link rel="stylesheet" media="screen" href="/jslib/handsontable/handsontable.full.min.css">
    <script src="/jslib/handsontable/numbro/languages/ru-RU.min.js"></script>
    <script src="/jslib/numeral/languages/ru.js"></script>
    <script src="/jslib/moment/moment-with-locales.js"></script>
    <link rel="stylesheet" href="/jslib/dijit/themes/claro/claro.css" media="screen">
    <script type="text/javascript" src="/jslib/dojo/dojo.js" data-dojo-config="async:true,parseOnLoad:false"></script>
    <link rel="stylesheet" href="/jslib/htable.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/css/sysadmin.css" media="screen">
    <title>MODA.UA</title>
</head>
<body class="claro" style="display: none" id="hideAll">
<div id="sysadmin_MainContainer">
    <div id="sysadmin_TopContainer" style="height:63px; margin:0; padding:0">
        <div id="sysadmin_TopImg"></div>
        <div id="sysadmin_TopStateInfo">
            <div id="sysadmin_app_user" style="display:inline;"></div>
            <div id="sysadmin_app_mode" style="display:inline;inline;margin-left:20px;"></div>
            <div id="sysadmin_app_port" style="display:inline; margin-left:20px;"></div>
            <div id="sysadmin_dbName" style="display:inline;;margin-left:20px;"></div>
            <div id="sysadmin_ConnUserName" style="display:inline;;margin-left:20px;"></div>
            <div id="sysadmin_connectToDBState" style="display:inline;margin-left:20px;"></div>
            <div id="sysadmin_dbValidateState" style="display:inline;margin-left:20px;"></div>
        </div>
        <div id="sysadmin_TopActions">
            <table>
                <tr>
                    <td>
                        <button id="sysadmin_btnServerConfig">Server configuration</button>
                    </td>
                    <td>
                        <button id="sysadmin_btnDatabase">Database</button>
                    </td>
                    <td width="500px"></td>
                    <td>
                        <button id="btnLogout">Logout</button>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div id="sysadmin_ContentContainer"></div>
</div>
</body>
<script type="text/javascript">
    require(["app", "dijit/layout/BorderContainer", "dijit/layout/StackContainer", "dijit/layout/ContentPane",
                "dijit/form/ToggleButton", "dojox/layout/ContentPane", "dijit/form/Button",  "request", "dojo/domReady!"],
            function (APP, BorderContainer, StackContainer, ContentPane, ToggleButton, XContentPane, Button, Request) {     console.log("STARTING SYSADMIN PAGE...");//!!!IT'S FOR TESTING!!!
               moment.locale("uk");

                document.getElementById("hideAll").style.display = "inline";

                var sysadmin_MainContainer = APP.instanceForID("sysadmin_MainContainer", BorderContainer, {design: "headline"});
                var sysadmin_TopContainer = APP.instanceForID("sysadmin_TopContainer",
                        BorderContainer, {
                            region: "top",
                            design: "sidebar",
                            class: "sysadmin_TopContent",
                            gutters: true
                        });
                var sysadmin_TopImg = APP.instanceForID("sysadmin_TopImg", ContentPane, {
                    region: "left",
                    class: "sysadmin_TopContent"
                });

                var sysadmin_TopStateInfo = APP.instanceForID("sysadmin_TopStateInfo", ContentPane, {
                    region: "top",
                    class: "sysadmin_TopContent"
                });
                var sysadmin_TopActions = APP.instanceForID("sysadmin_TopActions", ContentPane, {
                    region: "bottom",
                    class: "sysadmin_TopContent"
                });

                var functionalButtons=[];

                var sysadmin_btnServerConfig = new ToggleButton({id:"sysadmin_btnServerConfig",iconClass:'dijitCheckBoxIcon'},"sysadmin_btnServerConfig");
                functionalButtons.push(sysadmin_btnServerConfig);
                var sysadmin_btnDatabase = new ToggleButton({id:"sysadmin_btnDatabase",iconClass:'dijitCheckBoxIcon'},"sysadmin_btnDatabase");
                functionalButtons.push(sysadmin_btnDatabase);
                var btnLogout = new ToggleButton({id:"btnLogout"},"btnLogout");

                btnLogout.onClick=function(){
                    document.cookie="mduUser=";
                    document.cookie="mduPswrd=";
                    location.reload();
                };

                var sysadmin_ContentContainer = APP.instanceForID("sysadmin_ContentContainer",
                        StackContainer, {region: "center", tabPosition: "top", class: "sysadmin_Content"});
                sysadmin_MainContainer.startup();
                /**
                 * params = { revalidate:true/false }
                 */
                sysadmin_MainContainer.updateDBState = function (params) {   //getting main json data from server and run action parameter function
                    var condition;
                    if(params&&params.revalidate) condition={"REVALIDATE":true};
                    Request.getJSONData({url: "/sysadmin/serverState", condition:condition, consoleLog: true},
                            function (success, result) {
                                if (success) {
                                    if (result === undefined || result == null) result = [];
                                    sysadmin_MainContainer.mainContentData = result;
                                    var eAppUser = document.getElementById("sysadmin_app_user");
                                    var eAppMode = document.getElementById("sysadmin_app_mode");
                                    var eAppPort = document.getElementById("sysadmin_app_port");
                                    eAppUser.innerHTML = "<b>USER:</b>";
                                    eAppMode.innerHTML = "<b>MODE:</b>";
                                    eAppPort.innerHTML = "<b>PORT:</b>";
                                    if (result.appUserName) eAppUser.innerHTML = eAppUser.innerHTML + "<b><span style='color:dimgrey'>" + result.appUserName + "</span></b>";
                                    else eAppUser.innerHTML = eAppUser.innerHTML + "<b>UNKNOWN!!!</b>";
                                    if (result.mode) {
                                        if (result.mode.toString().toLocaleLowerCase().indexOf("production") < 0)
                                            eAppMode.innerHTML = eAppMode.innerHTML + "<b style='color:red'>" + result.mode + "</b>";
                                        else
                                            eAppMode.innerHTML = eAppMode.innerHTML + "<b style='color:dimgrey'>" + result.mode + "</b>";
                                    } else
                                        eAppMode.innerHTML = eAppMode.innerHTML + "<b>UNKNOWN!!!</b>";
                                    if(result.port)
                                        eAppPort.innerHTML=eAppPort.innerHTML+"<b style='color:dimgrey'>"+ result.port+"</b>";
                                    else
                                        eAppPort.innerHTML=eAppPort.innerHTML+"<b style='color:dimgrey'>UNKNOWN</b>";
                                    if (result.configuration) {
                                        document.getElementById("sysadmin_dbName").innerHTML =
                                                "<b>DB NAME:<span style='color:dimgrey'>" + result.configuration.database + "</span></b>";
                                        document.getElementById("sysadmin_ConnUserName").innerHTML =
                                                "<b>DB USER:<span style='color:dimgrey'>" + result.configuration.user + "</span></b>"
                                    } else {
                                        document.getElementById("sysadmin_dbName").innerHTML =
                                                "<b>DB NAME:<span style='color:dimgrey'>UNKNOWN</span></b>";
                                        document.getElementById("sysadmin_ConnUserName").innerHTML =
                                                "<b>DB USER:<span style='color:dimgrey'>UNKNOWN</span></b>"
                                    }
                                    if (result.dbConnection) {
                                        document.getElementById("sysadmin_connectToDBState").innerHTML =
                                                "<b>DB CONNECTION STATE:<span id ='dbConnection_color'>" + result.dbConnection + "</span></b>";
                                        var dbConnection_color = document.getElementById("dbConnection_color");
                                        if (result.dbConnection == "Connected") {
                                            dbConnection_color.setAttribute("style", "color:dimgrey");
                                            sysadmin_TopContainer.set("style","height:63px; margin:0; padding:0");
                                        }else {
                                            dbConnection_color.setAttribute("style", "color:red");
                                            sysadmin_TopContainer.set("style","height:75px; margin:0; padding:0");
                                        }
                                    } else {
                                        document.getElementById("sysadmin_connectToDBState").innerHTML =
                                                "<b>DB CONNECTION STATE:<span id ='dbConnection_color'>UNKNOWN</span></b>";
                                    }
                                    if (result.dbValidation) {
                                        document.getElementById("sysadmin_dbValidateState").innerHTML =
                                                "<b>DB VALIDATION STATE:<span id ='dbValidationcolor'>" + result.dbValidation + "</span></b>";
                                        var dbValidationColor = document.getElementById("dbValidationcolor");
                                        if (result.dbValidation == "success") {
                                            dbValidationColor.setAttribute("style", "color:dimgrey");
                                            sysadmin_TopContainer.set("style","height:63px; margin:0; padding:0");
                                        }else {
                                            dbValidationColor.setAttribute("style", "color:red");
                                            sysadmin_TopContainer.set("style","height:75px; margin:0; padding:0");
                                        }
                                    }
                                    sysadmin_TopContainer.resize();
                                    sysadmin_MainContainer.layout();
                                } else {
                                    sysadmin_MainContainer.mainContentData = [];
                                    sysadmin_MainContainer.mainContentData["error"] = result;
                                }
                            }
                    )
                };
                sysadmin_MainContainer.runSysadminContentPage = function (owner, id, title, closable, contentURL) {     console.log("sysadmin_MainContainer.runSysadminContentPage: ", contentURL);//!!!IT'S FOR TESTING!!!
                    if(!owner.pageContentPane){
                        owner.pageContentPane=
                                APP.childFor(sysadmin_ContentContainer, "PageContentPane_" + id,
                                        XContentPane, {title: title, closable: closable,parseOnLoad: false,style: "margin:0;padding:0;"});
                        owner.pageContentPane.set("content", "");
                        owner.pageContentPane.set("href", contentURL);
                        owner.pageContentPane.updateDBState = sysadmin_MainContainer.updateDBState;
                    }
                    sysadmin_ContentContainer.selectChild(owner.pageContentPane);
                };

                var checkButton= function(button){
                    button.set("checked", true);
                    for(var i in functionalButtons){
                        var anotherBtn=functionalButtons[i];
                        if(anotherBtn!=button){
                            anotherBtn.set("checked", false);
                        }
                    }
                };

                sysadmin_btnServerConfig.onClick=function() {
                   sysadmin_MainContainer.runSysadminContentPage(sysadmin_btnServerConfig, "sysadmin_ServerConfig", "Server configuration", false, "/sysadmin/serverConfig");
                    checkButton(this);
                };

                sysadmin_btnDatabase.onClick=function(){
                    sysadmin_MainContainer.runSysadminContentPage(sysadmin_btnDatabase, "sysadmin_btnDatabase", "Database", false, "/sysadmin/database");
                    checkButton(this);
                };

                sysadmin_MainContainer.updateDBState();
            });
</script>
</html>